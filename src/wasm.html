<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mojibake WASM</title>
    <style>body { background-color: rgb(13, 17, 23); }</style>
</head>
<body>
    <script type="module">
        let mojibakeModule;
        let offset = 0;

        function u8(ptr) {
            const ret = mojibakeModule.HEAPU8[ptr + offset];
            offset += 1;
            return ret;
        }

        function u16(ptr) {
            // Ensure 2-byte alignment
            offset = Math.ceil(offset / 2) * 2;
            const ret = new DataView(mojibakeModule.HEAPU8.buffer, ptr + offset).getUint16(0, true);
            offset += 2;
            return ret;
        }

        function u32(ptr) {
            // Ensure 4-byte alignment
            offset = Math.ceil(offset / 4) * 4;
            const ret = new DataView(mojibakeModule.HEAPU8.buffer, ptr + offset).getUint32(0, true);
            offset += 4;
            return ret;
        }

        function i32(ptr) {
            // Ensure 4-byte alignment
            offset = Math.ceil(offset / 4) * 4;
            const ret = new DataView(mojibakeModule.HEAPU8.buffer, ptr + offset).getInt32(0, true);
            offset += 4;
            return ret;
        }

        function str(ptr, max) {
            const nameBytes = new Uint8Array(mojibakeModule.HEAPU8.buffer, ptr + offset, max);
            let end = nameBytes.indexOf(0);

            if(end === -1) {
                end = max;
            }

            offset += max;

            return new TextDecoder().decode(nameBytes.subarray(0, end));
        }

        // Load the WASM module
        import('./mojibake.js').then(async (Module) => {
            mojibakeModule = await Module.default();
            console.log('Mojibake WASM module loaded successfully');
            console.log('Version:', mojibakeModule.ccall('mjb_version', 'string'));

            const dbResponse = await fetch('mojibake.db');
            const dbArrayBuffer = await dbResponse.arrayBuffer();
            const dbBytes = new Uint8Array(dbArrayBuffer);
            const dbPtr = mojibakeModule._malloc(dbBytes.length);
            mojibakeModule.HEAPU8.set(dbBytes, dbPtr);

            let initialized = mojibakeModule.ccall('mjb_initialize_v2', 'boolean',
                ['number', 'number', 'number', 'number', 'number'], [0, 0, 0, dbPtr, dbBytes.length]);

            console.log('Initialized:', initialized);

            // Test mjb_codepoint_character function
            testCodepointCharacter(0x1F64);

            function testCodepointCharacter(codepoint) {
                offset = 0;
                // Allocate memory for mjb_character structure
                const structSize = 512;
                const ptr = mojibakeModule._malloc(structSize);

                // Initialize memory to zero
                for(let i = 0; i < structSize; i++) {
                    mojibakeModule.HEAPU8[ptr + i] = 0;
                }

                // Call mjb_codepoint_character
                const result = mojibakeModule.ccall('mjb_codepoint_character', 'boolean',
                    ['number', 'number'], [codepoint, ptr]);

                if(result) {
                    const codepoint = u32(ptr);
                    const name = str(ptr, 128);
                    const category = u32(ptr);
                    const combining = u32(ptr);
                    const bidirectional = u16(ptr);
                    const decomposition = u32(ptr);
                    let decimal = i32(ptr);
                    let digit = i32(ptr);
                    const numeric = str(ptr, 16);
                    const mirrored = u8(ptr);
                    const uppercase = u32(ptr);
                    const lowercase = u32(ptr);
                    const titlecase = u32(ptr);

                    if(decimal === -1) {
                        decimal = null;
                    }

                    if(digit === -1) {
                        digit = null;
                    }

                    console.log(`Character U+${codepoint.toString(16).toUpperCase().padStart(4, '0')}:`);
                    console.log(`Name: ${name}`);
                    console.log(`Category: ${category}`);
                    console.log(`Combining Class: ${combining}`);
                    console.log(`Bidirectional: ${bidirectional}`);
                    console.log(`Decimal: ${decimal}`);
                    console.log(`Digit: ${digit}`);
                    console.log(`Numeric: ${numeric}`);
                    console.log(`Mirrored: ${mirrored}`);
                    console.log(`Uppercase: U+${uppercase.toString(16).toUpperCase().padStart(4, '0')}`);
                    console.log(`Lowercase: U+${lowercase.toString(16).toUpperCase().padStart(4, '0')}`);
                    console.log(`Titlecase: U+${titlecase.toString(16).toUpperCase().padStart(4, '0')}`);
                } else {
                    console.log(`Failed to get character data for U+${codepoint.toString(16).toUpperCase().padStart(4, '0')}`);
                }

                // Free allocated memory
                mojibakeModule._free(ptr);
            }
        }).catch(err => {
            console.error('Failed to load WASM module:', err);
        });
    </script>
</body>
</html>
