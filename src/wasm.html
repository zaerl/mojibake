<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mojibake WASM</title>
    <style>body { background-color: rgb(13, 17, 23); }</style>
</head>
<body>
    <script type="module">
        let mojibakeModule;

        class CStruct {
            #ptr;
            #offset = 0;

            constructor(ptr) {
                this.#ptr = ptr;
                this.#offset = 0;
            }

            u8() {
                const ret = mojibakeModule.HEAPU8[this.#ptr + this.#offset];
                this.#offset += 1;
                return ret;
            }

            u16() {
                // Ensure 2-byte alignment
                this.#offset = Math.ceil(this.#offset / 2) * 2;
                const ret = new DataView(mojibakeModule.HEAPU8.buffer, this.#ptr + this.#offset).getUint16(0, true);
                this.#offset += 2;
                return ret;
            }

            u32() {
                // Ensure 4-byte alignment
                this.#offset = Math.ceil(this.#offset / 4) * 4;
                const ret = new DataView(mojibakeModule.HEAPU8.buffer, this.#ptr + this.#offset).getUint32(0, true);
                this.#offset += 4;
                return ret;
            }

            i32() {
                // Ensure 4-byte alignment
                this.#offset = Math.ceil(this.#offset / 4) * 4;
                const ret = new DataView(mojibakeModule.HEAPU8.buffer, this.#ptr + this.#offset).getInt32(0, true);
                this.#offset += 4;
                return ret;
            }

            str(max) {
                const nameBytes = new Uint8Array(mojibakeModule.HEAPU8.buffer, this.#ptr + this.#offset, max);
                let end = nameBytes.indexOf(0);

                if(end === -1) {
                    end = max;
                }

                this.#offset += max;

                return new TextDecoder().decode(nameBytes.subarray(0, end));
            }

            toObject(signature) {
                const object = {};

                for(const name in signature) {
                    if(signature[name].startsWith('str')) {
                        object[name] = this.str(Number(signature[name].split('str')[1]));
                    } else {
                        object[name] = this[signature[name]]();
                    }
                }

                return object;
            }
        }

        // Load the WASM module
        import('./mojibake.js').then(async (Module) => {
            mojibakeModule = await Module.default();
            console.log('Mojibake WASM module loaded. Version:', mojibakeModule.ccall('mjb_version', 'string'));

            const dbResponse = await fetch('mojibake.db');
            const dbArrayBuffer = await dbResponse.arrayBuffer();
            const dbBytes = new Uint8Array(dbArrayBuffer);
            const dbPtr = mojibakeModule._malloc(dbBytes.length);
            mojibakeModule.HEAPU8.set(dbBytes, dbPtr);

            let initialized = mojibakeModule.ccall('mjb_initialize_v2', 'boolean',
                ['number', 'number', 'number', 'number', 'number'], [0, 0, 0, dbPtr, dbBytes.length]);

            // Test mjb_codepoint_character function
            testCodepointCharacter(0x1F64);

            function codepointToString(codepoint) {
                return 'U+' + codepoint.toString(16).toUpperCase().padStart(4, '0');
            }

            function testCodepointCharacter(codepoint) {
                // Allocate memory for mjb_character structure
                const structSize = 512;
                const ptr = mojibakeModule._malloc(structSize);

                // Initialize memory to zero
                for(let i = 0; i < structSize; i++) {
                    mojibakeModule.HEAPU8[ptr + i] = 0;
                }

                // Call mjb_codepoint_character
                const result = mojibakeModule.ccall('mjb_codepoint_character', 'boolean',
                    ['number', 'number'], [codepoint, ptr]);

                if(result) {
                    const struct = new CStruct(ptr);
                    const char = struct.toObject({
                        codepoint: 'u32',
                        name: 'str128',
                        category: 'u32',
                        combining: 'u32',
                        bidirectional: 'u16',
                        decomposition: 'u32',
                        decimal: 'i32',
                        digit: 'i32',
                        numeric: 'str16',
                        mirrored: 'u8',
                        uppercase: 'u32',
                        lowercase: 'u32',
                        titlecase: 'u32',
                    });

                    if(char.decimal === -1) {
                        char.decimal = null;
                    }

                    if(char.digit === -1) {
                        char.digit = null;
                    }

                    console.log(`Character ${codepointToString(char.codepoint)}:`);
                    console.log(`Name: ${char.name}`);
                    console.log(`Category: ${char.category}`);
                    console.log(`Combining Class: ${char.combining}`);
                    console.log(`Bidirectional: ${char.bidirectional}`);
                    console.log(`Decimal: ${char.decimal}`);
                    console.log(`Digit: ${char.digit}`);
                    console.log(`Numeric: ${char.numeric}`);
                    console.log(`Mirrored: ${char.mirrored}`);
                    console.log(`Uppercase: ${codepointToString(char.uppercase)}`);
                    console.log(`Lowercase: ${codepointToString(char.lowercase)}`);
                    console.log(`Titlecase: ${codepointToString(char.titlecase)}`);
                } else {
                    console.log(`Failed to get character data for ${codepointToString(codepoint)}`);
                }

                // Free allocated memory
                mojibakeModule._free(ptr);
            }
        }).catch(err => {
            console.error('Failed to load WASM module:', err);
        });
    </script>
</body>
</html>
